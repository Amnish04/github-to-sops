#!/usr/bin/env python3
"""
This script fetches SSH keys of GitHub repository contributors.
"""

import argparse
import json
import os
import sys
import subprocess
from typing import Optional, List
from urllib import request, error

GITHUB_API_BASE_URL = 'https://api.github.com/repos'


def get_api_url_from_git(repo_path: str) -> Optional[str]:
    """
    Extract the GitHub API URL from the local git repository config.

    :param repo_path: Path to the local git repository.
    :return: GitHub API URL or None if not found.
    """
    config_path = os.path.join(repo_path, '.git', 'config')
    try:
        with open(config_path, 'r') as git_config:
            for line in git_config:
                if 'url' in line:
                    git_url = line.split('=')[1].strip()
                    if git_url.startswith('https://github.com/'):
                        return git_url.replace('github.com', GITHUB_API_BASE_URL, 1)
                    elif git_url.startswith('git@github.com:'):
                        return (git_url.replace('git@github.com:', GITHUB_API_BASE_URL + '/', 1)
                                .rstrip('.git'))
    except FileNotFoundError:
        print(f"Error: {config_path} not found.", file=sys.stderr)
    return None


def get_api_url(repo_url: Optional[str], local_repo: Optional[str]) -> str:
    """
    Determine the GitHub API URL from either a repository URL or a local repository path.

    :param repo_url: GitHub repository URL.
    :param local_repo: Path to local Git repository.
    :return: GitHub API URL.
    :raises ValueError: If neither a repository URL nor a local repository path is provided.
    """
    if repo_url:
        return repo_url.replace('github.com', GITHUB_API_BASE_URL, 1)
    elif local_repo:
        api_url = get_api_url_from_git(local_repo)
        if api_url:
            return api_url
        else:
            raise ValueError("Unable to determine the repository URL from the local Git repository.")
    else:
        raise ValueError("Either a repository URL or a local repository path must be provided.")


def github_request(request_url: str):
    """
    Make a request to the GitHub API.
    This injects the GitHub API token environment variable into the request if present.

    :param request_url: URL to make the request to.
    :return: Response from the GitHub API.
    """
    req = request.Request(request_url)
    github_token = os.getenv('GITHUB_TOKEN')
    if github_token:
        auth_header = f"token {github_token}"
        req.add_header('Authorization', auth_header)
    return request.urlopen(req)


def fetch_contributors(api_url: str) -> List[str]:
    """
    Fetch the list of contributors for a GitHub repository.

    :param api_url: GitHub API URL for the repository.
    :return: List of contributor usernames.
    """
    try:
        with github_request(f"{api_url}/contributors") as response:
            contributors = json.load(response)
            return [contributor['login'] for contributor in contributors]
    except error.HTTPError as e:
        print(f"HTTP Error: {e.code} {e.reason}", file=sys.stderr)
        return []


def convert_key_to_age(key: str) -> Optional[str]:
    """
    Convert an SSH key to an age key using ssh-to-age.

    :param key: The SSH key to convert.
    :return: The age key or None if conversion fails.
    """
    try:
        result = subprocess.run(
            ['ssh-to-age'], input=key, capture_output=True, text=True
        )
        if result.returncode == 0:
            return result.stdout.strip()
        else:
            print(f"Error converting key: {result.stderr}", file=sys.stderr)
            return None
    except Exception as e:
        print(f"Error running ssh-to-age: {e}", file=sys.stderr)
        return None


def fetch_and_output_ssh_keys(contributors: List[str], key_type: str, convert_to_age: bool):
    """
    Fetch and output the specified type of SSH keys for a list of GitHub users.
    Optionally convert the keys to age keys using ssh-to-age.

    :param contributors: List of GitHub usernames.
    :param key_type: The type of SSH key to fetch (e.g., 'ssh-ed25519').
    :param convert_to_age: Whether to convert the keys to age keys.
    """
    for username in contributors:
        try:
            with github_request(f"https://github.com/{username}.keys") as response:
                keys = response.read().decode().splitlines()
                filtered_keys = [key for key in keys if key.startswith(key_type)]
                if not filtered_keys:
                    print(f"User {username} does not have {key_type} keys.", file=sys.stderr)
                else:
                    for key in filtered_keys:
                        if convert_to_age:
                            age_key = convert_key_to_age(key)
                            if age_key:
                                print(f"{age_key} {username}")
                        else:
                            print(f"{key} {username}")
        except error.HTTPError as e:
            print(f"HTTP Error: {e.code} {e.reason} for user {username}", file=sys.stderr)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Fetch SSH keys of GitHub repository contributors or specified users.")
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument('-g', '--github-url', help="GitHub repository URL.")
    group.add_argument('-l', '--local-checkout', help="Path to local Git repository.")
    parser.add_argument('-u', '--users', nargs='+', help="List of GitHub usernames to fetch keys for.")
    parser.add_argument('-k', '--key-type', default='ssh-ed25519', help="Type of SSH key to fetch.")
    parser.add_argument('--enable-ssh-to-age', dest='convert_to_age', action='store_true', help="Convert SSH keys to age keys using ssh-to-age.")
    parser.add_argument('--disable-ssh-to-age', dest='convert_to_age', action='store_false', help="Do not convert SSH keys to age keys.")
    parser.set_defaults(convert_to_age=False)
    args = parser.parse_args()

    users = args.users if args.users else fetch_contributors(get_api_url(args.github_url, args.local_checkout))
    if not users:
        print("No users found or error fetching users.", file=sys.stderr)
        sys.exit(1)

    fetch_and_output_ssh_keys(users, args.key_type, args.convert_to_age)